// Copyright 2000-2023 JetBrains s.r.o. and contributors. Use of this source code is governed by the Apache 2.0 license.
//file:noinspection GrPackage

gradle.taskGraph.whenReady { taskGraph ->
  taskGraph.allTasks.each { Task task ->
    if (task instanceof Test) {
      task.doFirst {
        try {
          def urls = task.classpath.files.findAll {
            it.name == 'idea_rt.jar' || it.name.startsWith('junit')
          }.collect { it.toURI().toURL() }
          def classLoader = Class.forName("org.gradle.launcher.daemon.bootstrap.DaemonMain").getClassLoader()
          if (classLoader instanceof URLClassLoader) {
            for (URL url : urls) {
              //noinspection GroovyAccessibility
              classLoader.addURL(url)
            }
          }
          else {
            logger.error("unable to enhance gradle daemon classloader with idea_rt.jar")
          }
        }
        catch (RuntimeException all) {
          logger.error("unable to enhance gradle daemon classloader with idea_rt.jar", all)
        }
      }
    }
  }
}